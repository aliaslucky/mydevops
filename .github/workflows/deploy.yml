# Build and Deploy (fixed)
name: Build and Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build .NET app
        run: dotnet publish ./app -c Release -o publish

      - name: Debug SSH variables
        if: ${{ always() }}
        run: |
          echo "USER='${{ secrets.SSH_USER }}'"
          echo "HOST='${{ secrets.SSH_HOST }}'"
          echo "PORT='${{ secrets.SSH_PORT }}'"

      # Create SSH key file BEFORE any scp/ssh steps
      - name: Decode SSH key from Base64        
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" | base64 --decode > ~/.ssh/github_actions_key
          chmod 600 ~/.ssh/github_actions_key

      - name: Debug key header
        run: |
          echo "----- START KEY -----"
          head -n 5 ~/.ssh/github_actions_key || true
          echo "----- END KEY -----"

      - name: Check key validity (fingerprint)
        run: |
          ssh-keygen -y -f ~/.ssh/github_actions_key > /tmp/github_actions_key.pub
          ssh-keygen -l -f /tmp/github_actions_key.pub || true


      # Copy build to remote host using the key
      - name: Copy build to remote host
        run: |          
          # scp uses -P (capital P) to specify non-default port
          scp -i ~/.ssh/github_actions_key -o StrictHostKeyChecking=no -P "${{ secrets.SSH_PORT }}" -r ./publish/* "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/Users/admin/Documents/CORSI/CORSO_NET/Code/MyIaC/DevOps/02_DevOps/vol/"

      - name: Restart container on remote host
        run: |
          ssh -i ~/.ssh/github_actions_key -o StrictHostKeyChecking=no -p "${{ secrets.SSH_PORT }}" "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" "docker restart mydevops_container"

      - name: Deploy into container on remote host
        run: |
          ssh -i ~/.ssh/github_actions_key -o StrictHostKeyChecking=no -p "${{ secrets.SSH_PORT }}" "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" << 'EOF'
          # Copy from the directory where we uploaded files into the container
          docker cp /Users/admin/Documents/CORSI/CORSO_NET/Code/MyIaC/DevOps/02_DevOps/vol/. mydevops_container:/app
          docker exec mydevops_container pkill dotnet || true
          EOF