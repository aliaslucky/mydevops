# Nome del workflow
name: Build and Deploy

# Trigger: esegue il workflow a ogni push sul branch main
on:
  push:
    branches: [ "main" ]

jobs:
  # Nome del job
  build:
    # Usa una macchina Ubuntu di GitHub Actions
    runs-on: ubuntu-latest

    steps:
      # Checkout del repository per accedere ai file
      - uses: actions/checkout@v4

      # Compila l'app .NET e genera la cartella publish
      - name: Build .NET app
        run: dotnet publish ./app -c Release -o publish
    # ðŸ”¥ Disabilita lâ€™SSH agent che causa i tentativi multipli
      - name: Disable SSH agent
        run: |
         eval "$(ssh-agent -k)" || true

     # Crea il file della chiave privata RSA per SSH
      - name: Create SSH key file
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      # Connessione SSH alla macchina locale per fare il deploy
      - name: Deploy to local machine via SSH
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o IdentitiesOnly=yes \
              -o PreferredAuthentications=publickey \
              -i ~/.ssh/id_rsa \
              -p "${{ secrets.SSH_PORT }}" \
              "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" \
              '
              # Copia i file compilati dentro il container esistente
              docker cp publish/. mydevops_container:/app

              # Riavvia il processo dotnet dentro il container (senza ricrearlo)
              docker exec mydevops_container pkill dotnet || true
              '